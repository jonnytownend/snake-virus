import fs from "node:fs/promises";
import path from "node:path";

const ROOT = process.cwd();
const OUT_FILE = path.join(ROOT, "src/game/source-corpus.js");

const INCLUDE_EXTENSIONS = new Set([".js"]);
const IGNORE_DIRS = new Set([".git", "node_modules", "coverage", "dist", "build"]);
const IGNORE_FILES = new Set([
  "src/game/source-corpus.js",
  "package-lock.json"
]);

function shouldInclude(relPath) {
  const normalized = relPath.replace(/\\/g, "/");
  if (normalized === "jest.config.js") return true;
  if (normalized.startsWith("src/")) return true;
  if (normalized.startsWith("scripts/")) return true;
  if (normalized.startsWith("tests/")) return true;
  return false;
}

async function walk(dir) {
  const entries = await fs.readdir(dir, { withFileTypes: true });
  const files = [];

  for (const entry of entries) {
    const abs = path.join(dir, entry.name);
    const rel = path.relative(ROOT, abs).replace(/\\/g, "/");

    if (entry.isDirectory()) {
      if (IGNORE_DIRS.has(entry.name)) continue;
      files.push(...(await walk(abs)));
      continue;
    }

    if (!entry.isFile()) continue;
    if (IGNORE_FILES.has(rel)) continue;
    if (!shouldInclude(rel)) continue;

    const ext = path.extname(entry.name);
    if (!INCLUDE_EXTENSIONS.has(ext)) continue;

    files.push(rel);
  }

  return files;
}

async function buildCorpus() {
  const paths = (await walk(ROOT)).sort();
  const corpus = [];

  for (const relPath of paths) {
    const absPath = path.join(ROOT, relPath);
    const content = await fs.readFile(absPath, "utf8");
    corpus.push({
      path: relPath,
      content
    });
  }

  return corpus;
}

function renderModule(corpus) {
  const payload = JSON.stringify(corpus, null, 2);
  return `// Auto-generated by scripts/generate-source-corpus.mjs\n// Do not edit manually.\n\nexport const SOURCE_CORPUS = ${payload};\n`;
}

const corpus = await buildCorpus();
const output = renderModule(corpus);
await fs.writeFile(OUT_FILE, output, "utf8");

console.log(`Generated source corpus with ${corpus.length} files -> ${path.relative(ROOT, OUT_FILE)}`);
